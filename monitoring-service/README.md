# Components

## Fluent-Bit
[Fluent Bit](http://fluentbit.io/) is an open source and multi-platform Log Forwarder. 

This chart will do the following:
* Install a configmap for Fluent Bit
* Install a daemonset that provisions Fluent Bit [per-host architecture]

## APM-server
[Kibana](https://github.com/elastic/kibana) allows you to collect application metrics from various APM-agents

## Kibana
[Kibana](https://github.com/elastic/kibana) is your window into the Elastic Stack. Specifically, it's an open source (Apache Licensed), browser-based analytics and search dashboard for Elasticsearch.

## Elasticsearch
This chart is based on the [Elasticsearch](https://www.docker.elastic.co/) image.

# Configurations

## Fluent-Bit
The following tables lists the configurable parameters of the Fluent-Bit chart and the default values.

| Parameter                     | Description                                                                                                                | Default                                                |
|:------------------------------|:---------------------------------------------------------------------------------------------------------------------------|:-------------------------------------------------------|
| **Backend Selection**         |                                                                                                                            |                                                        |
| `backend.type`                | Set the backend to which Fluent-Bit should flush the information it gathers                                                | `forward`                                              |
| **Forward Backend**           |                                                                                                                            |                                                        |
| `backend.forward.host`        | Target host where Fluent-Bit or Fluentd are listening for Forward messages                                                 | `fluentd`                                              |
| `backend.forward.port`        | TCP Port of the target service                                                                                             | `24284`                                                |
| **ElasticSearch Backend**     |                                                                                                                            |                                                        |
| `backend.es.host`             | IP address or hostname of the target Elasticsearch instance                                                                | `elasticsearch`                                        |
| `backend.es.port`             | TCP port of the target Elasticsearch instance.                                                                             | `9200`                                                 |
| `backend.es.index`            | Elastic Index name                                                                                                         | `kubernetes_cluster`                                   |
| `backend.es.type`             | Elastic Type name                                                                                                          | `flb_type`                                             |
| `backend.es.logstash_prefix`  | Index Prefix. If Logstash_Prefix is equals to 'mydata' your index will become 'mydata-YYYY.MM.DD'.                         | `kubernetes_cluster`                                   |
| `backend.es.http_user`        | Optional username credential for Elastic X-Pack access.                                                                    | ``                                                     |
| `backend.es.http_passwd:`     | Password for user defined in HTTP_User.                                                                                    | ``                                                     |
| `backend.es.tls`              | Enable or disable TLS support                                                                                              | `off`                                                  |
| `backend.es.tls_verify`       | Force certificate validation                                                                                               | `on`                                                   |
| `backend.es.tls_ca`           | TLS CA certificate for the Elastic instance (in PEM format). Specify if tls: on.                                           | ``                                                     |
| `backend.es.tls_debug`        | Set TLS debug verbosity level. It accept the following values: 0-4                                                         | `1`                                                    |
| **HTTP Backend**              |                                                                                                                            |                                                        |
| `backend.http.host`           | IP address or hostname of the target HTTP Server                                                                           | `127.0.0.1`                                            |
| `backend.http.port`           | TCP port of the target HTTP Server                                                                                         | `80`                                                   |
| `backend.http.uri`            | Specify an optional HTTP URI for the target web server, e.g: /something                                                    | `"/"`                                                  |
| `backend.http.format`         | Specify the data format to be used in the HTTP request body, by default it uses msgpack, optionally it can be set to json. | `msgpack`                                              |
| **Parsers**                   |                                                                                                                            |                                                        |
| `parsers.regex`               | List of regex parsers                                                                                                      | `NULL`                                                 |
| `parsers.json`                | List of json parsers                                                                                                       | `NULL`                                                 |
| **General**                   |                                                                                                                            |                                                        |
| `annotations`                 | Optional deamonset set annotations                                                                                         | `NULL`                                                 |
| `podAnnotations`              | Optional pod annotations                                                                                                   | `NULL`                                                 |
| `existingConfigMap`           | ConfigMap override                                                                                                         | ``                                                     |
| `extraVolumeMounts`           | Mount an extra volume, required to mount ssl certificates when elasticsearch has tls enabled                               |                                                        |
| `extraVolume`                 | Extra volume                                                                                                               |                                                        |
| `filter.kubeURL`              | Optional custom configmaps                                                                                                 | `https://kubernetes.default.svc:443`                   |
| `filter.kubeCAFile`           | Optional custom configmaps                                                                                                 | `/var/run/secrets/kubernetes.io/serviceaccount/ca.crt` |
| `filter.kubeTokenFile`        | Optional custom configmaps                                                                                                 | `/var/run/secrets/kubernetes.io/serviceaccount/token`  |
| `filter.kubeTag`              | Optional top-level tag for matching in filter                                                                              | `kube`                                                 |
| `image.fluent_bit.repository` | Image                                                                                                                      | `fluent/fluent-bit`                                    |
| `image.fluent_bit.tag`        | Image tag                                                                                                                  | `0.13.0`                                               |
| `image.pullPolicy`            | Image pull policy                                                                                                          | `Always`                                               |
| `rbac.create`                 | Specifies whether RBAC resources should be created.                                                                        | `true`                                                 |
| `serviceAccount.create`       | Specifies whether a ServiceAccount should be created.                                                                      | `true`                                                 |
| `serviceAccount.name`         | The name of the ServiceAccount to use.                                                                                     | `NULL`                                                 |
| `resources.limits.cpu`        | CPU limit                                                                                                                  | `100m`                                                 |
| `resources.limits.memory`     | Memory limit                                                                                                               | `500Mi`                                                |
| `resources.requests.cpu`      | CPU request                                                                                                                | `100m`                                                 |
| `resources.requests.memory`   | Memory request                                                                                                             | `200Mi`                                                |
| `tolerations`                 | Optional daemonset tolerations                                                                                             | `NULL`                                                 |
| `nodeSelector`                | Node labels for fluent-bit pod assignment                                                                                  | `NULL`                                                 |
| `metrics.enabled`             | Specifies whether a service for metrics should be exposed                                                                  | `false`                                                |
| `metrics.service.port`        | Port on where metrics should be exposed                                                                                    | `2020`                                                 |
| `metrics.service.type`        | Service type for metrics                                                                                                   | `ClusterIP`                                            |

## APM-Server
The following table lists the configurable parameters of the apm-server chart and their default values.

| Parameter                           | Description                                                                                                                                                                                               | Default                            |
|:------------------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:-----------------------------------|
| `image.repository`                  | The image repository to pull from                                                                                                                                                                         | `docker.elastic.co/apm/apm-server` |
| `image.tag`                         | The image tag to pull                                                                                                                                                                                     | `6.2.4`                            |
| `image.pullPolicy`                  | Image pull policy                                                                                                                                                                                         | `IfNotPresent`                     |
| `kind`                              | Install as Deployment or DaemonSet                                                                                                                                                                        | `Deployment`                       |
| `replicaCount`                      | Number of replicas when kind is Deployment                                                                                                                                                                | `1`                                |
| `updateStrategy`                    | Allows setting of RollingUpdate strategy                                                                                                                                                                  | `{}`                               |
| `service.enabled`                   | If true, create service pointing to APM Server                                                                                                                                                            | `true`                             |
| `service.type`                      | type of service                                                                                                                                                                                           | `ClusterIP`                        |
| `service.port`                      | Service port                                                                                                                                                                                              | `8200`                             |
| `service.portName`                  | Service port name                                                                                                                                                                                         | None                               |
| `service.clusterIP`                 | Static clusterIP or None for headless services                                                                                                                                                            | None                               |
| `service.externalIPs`               | External IP addresses                                                                                                                                                                                     | None                               |
| `service.loadBalancerIP`            | Load Balancer IP address                                                                                                                                                                                  | None                               |
| `service.loadBalancerSourceRanges`  | Limit load balancer source IPs to list of CIDRs (where available)                                                                                                                                         | `[]`                               |
| `service.nodePort`                  | NodePort value if service.type is NodePort                                                                                                                                                                | None                               |
| `service.annotations`               | Kubernetes service annotations                                                                                                                                                                            | None                               |
| `service.labels`                    | Kubernetes service labels                                                                                                                                                                                 | None                               |
| `ingress.enabled`                   | If true, create ingress pointing to service                                                                                                                                                               | `false`                            |
| `ingress.annotations`               | Kubernetes ingress annotations                                                                                                                                                                            | None                               |
| `ingress.labels`                    | Kubernetes service labels                                                                                                                                                                                 | None                               |
| `ingress.hosts`                     | List of ingress accepted hostnames                                                                                                                                                                        | apm-server-ingress.example.com     |
| `ingress.tls`                       | Ingress TLS configuration                                                                                                                                                                                 | `[]`                               |
| `rbac.create`                       | If true, create & use RBAC resources                                                                                                                                                                      | `true`                             |
| `rbac.serviceAccount`               | existing ServiceAccount to use (ignored if rbac.create=true)                                                                                                                                              | `default`                          |
| `config`                            | The content of the configuration file consumed by apm-server. See the [apm-server documentation](https://www.elastic.co/guide/en/beats/apm-server/current/apm-server-reference-yml.html) for full details |                                    |
| `plugins`                           | List of apm-server plugins                                                                                                                                                                                |                                    |
| `extraVars`                         | A map of additional environment variables                                                                                                                                                                 |                                    |
| `extraVolumes`, `extraVolumeMounts` | Additional volumes and mounts, for example to provide other configuration files                                                                                                                           |                                    |
| `resources.requests.cpu`            | CPU resource requests                                                                                                                                                                                     |                                    |
| `resources.limits.cpu`              | CPU resource limits                                                                                                                                                                                       |                                    |
| `resources.requests.memory`         | Memory resource requests                                                                                                                                                                                  |                                    |
| `resources.limits.memory`           | Memory resource limits                                                                                                                                                                                    |                                    |
| `nodeSelector`                      | Node labels for pod assignment                                                                                                                                                                            | `{}`                               |
| `tolerations`                       | List of node taints to tolerate                                                                                                                                                                           | `[]`                               |
| `affinity`                          | Node/Pod affinities                                                                                                                                                                                       | None                               |
| `autoscaling`                       | HorizontalPodAutoscaler for the deployment                                                                                                                                                                | `{}`                               |

## Kibana
The following table lists the configurable parameters of the Kibana chart and their default values.

| Parameter                | Description                                                      | Default        |
|:-------------------------|:-----------------------------------------------------------------|:---------------|
| `affinity`               | node/pod affinities                                              | None           |
| `env`                    | Environment variables to configure Kibana                        | `{}`           |
| `image.pullPolicy`       | Image pull policy                                                | `IfNotPresent` |
| `image.repository`       | Image repository                                                 | `kibana`       |
| `image.tag`              | Image tag                                                        | `6.0.0`        |
| `image.pullSecrets`      | Specify image pull secrets                                       | `nil`          |
| `commandline.args`       | add additional commandline args                                  | `nil`          |
| `ingress.enabled`        | Enables Ingress                                                  | `false`        |
| `ingress.annotations`    | Ingress annotations                                              | None:          |
| `ingress.hosts`          | Ingress accepted hostnames                                       | None:          |
| `ingress.tls`            | Ingress TLS configuration                                        | None:          |
| `nodeSelector`           | node labels for pod assignment                                   | `{}`           |
| `podAnnotations`         | annotations to add to each pod                                   | `{}`           |
| `replicaCount`           | desired number of pods                                           | `1`            |
| `resources`              | pod resource requests & limits                                   | `{}`           |
| `service.externalPort`   | external port for the service                                    | `443`          |
| `service.internalPort`   | internal port for the service                                    | `4180`         |
| `service.externalIPs`    | external IP addresses                                            | None:          |
| `service.loadBalancerIP` | Load Balancer IP address (to use with service.type LoadBalancer) | None:          |
| `service.type`           | type of service                                                  | `ClusterIP`    |
| `service.annotations`    | Kubernetes service annotations                                   | None:          |
| `tolerations`            | List of node taints to tolerate                                  | `[]`           |

## Elasticsearch
The following table lists the configurable parameters of the elasticsearch chart and their default values.

| Parameter                         | Description                                                         | Default                                         |
|:----------------------------------|:--------------------------------------------------------------------|:------------------------------------------------|
| `image.repository`                | Container image name                                                | `docker.elastic.co/elasticsearch/elasticsearch` |
| `image.tag`                       | Container image tag                                                 | `7.4.0`                                         |
| `image.pullPolicy`                | Container pull policy                                               | `IfNotPresent`                                  |
| `master.exposeHttp`               | Expose http port 9200 on master Pods for monitoring, etc            | `true`                                          |
| `master.replicas`                 | Master node replicas (statefulset)                                  | `3`                                             |
| `master.resources`                | Master node resources requests & limits                             | `{} - cpu limit must be an integer`             |
| `master.heapSize`                 | Master node heap size                                               | `512m`                                          |
| `master.name`                     | Master component name                                               | `master`                                        |
| `master.persistence.enabled`      | Master persistent enabled/disabled                                  | `true`                                          |
| `master.persistence.name`         | Master statefulset PVC template name                                | `data`                                          |
| `master.persistence.size`         | Master persistent volume size                                       | `10Gi`                                          |
| `master.persistence.storageClass` | Master persistent volume Class                                      | `nil`                                           |
| `master.persistence.accessMode`   | Master persistent Access Mode                                       | `ReadWriteOnce`                                 |
| `master.antiAffinity`             | Data anti-affinity policy                                           | `soft`                                          |
| `rbac.create`                     | Create service account and ClusterRoleBinding for Kubernetes plugin | `false`                                         |

## Metricbeats
The following table lists the configurable parameters of the Metricbeat chart and their default values.

| Parameter                | Description                                                                                                                                                                                                                                                                 | Default                                                                                                                   |
|:-------------------------|:----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|:--------------------------------------------------------------------------------------------------------------------------|
| `metricbeatConfig`       | Allows you to add any config files in `/usr/share/metricbeat` such as `metricbeat.yml`. See [values.yaml](./values.yaml) for an example of the formatting with the default configuration.                                                                                   | see [values.yaml](./values.yaml)                                                                                          |
| `extraEnvs`              | Extra [environment variables](https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container/#using-environment-variables-inside-of-your-config) which will be appended to the `env:` definition for the container                          | `[]`                                                                                                                      |
| `extraVolumeMounts`      | Templatable string of additional volumeMounts to be passed to the `tpl` function                                                                                                                                                                                            | `""`                                                                                                                      |
| `extraVolumes`           | Templatable string of additional volumes to be passed to the `tpl` function                                                                                                                                                                                                 | `""`                                                                                                                      |
| `hostPathRoot`           | Fully-qualified [hostPath](https://kubernetes.io/docs/concepts/storage/volumes/#hostpath) that will be used to persist Metricbeat registry data                                                                                                                             | `/var/lib`                                                                                                                |
| `image`                  | The Metricbeat docker image                                                                                                                                                                                                                                                 | `docker.elastic.co/beats/metricbeat`                                                                                      |
| `imageTag`               | The Metricbeat docker image tag                                                                                                                                                                                                                                             | `7.4.1`                                                                                                                   |
| `imagePullPolicy`        | The Kubernetes [imagePullPolicy](https://kubernetes.io/docs/concepts/containers/images/#updating-images) value                                                                                                                                                              | `IfNotPresent`                                                                                                            |
| `imagePullSecrets`       | Configuration for [imagePullSecrets](https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/#create-a-pod-that-uses-your-secret) so that you can use a private registry for your image                                                        | `[]`                                                                                                                      |
| `labels`                 | Configurable [label](https://kubernetes.io/docs/concepts/overview/working-with-objects/labels/) applied to all Metricbeat pods                                                                                                                                              | `{}`                                                                                                                      |
| `managedServiceAccount`  | Whether the `serviceAccount` should be managed by this helm chart. Set this to `false` in order to manage your own service account and related roles.                                                                                                                       | `true`                                                                                                                    |
| `clusterRoleRules`       | Configurable [cluster role rules](https://kubernetes.io/docs/reference/access-authn-authz/rbac/#role-and-clusterrole) that Metricbeat uses to access Kubernetes resources.                                                                                                  | see [values.yaml](./values.yaml)                                                                                          |
| `podAnnotations`         | Configurable [annotations](https://kubernetes.io/docs/concepts/overview/working-with-objects/annotations/) applied to all Metricbeat pods                                                                                                                                   | `{}`                                                                                                                      |
| `podSecurityContext`     | Configurable [podSecurityContext](https://kubernetes.io/docs/tasks/configure-pod-container/security-context/) for Metricbeat pod execution environment                                                                                                                      | `runAsUser: 0`<br>`privileged: false`                                                                                     |
| `livenessProbe`          | Parameters to pass to [liveness probe](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/) checks for values such as timeouts and thresholds.                                                                                    | `failureThreshold: 3`<br>`initialDelaySeconds: 10`<br>`periodSeconds: 10`<br>`successThreshold: 3`<br>`timeoutSeconds: 5` |
| `readinessProbe`         | Parameters to pass to [readiness probe](https://kubernetes.io/docs/tasks/configure-pod-container/configure-liveness-readiness-probes/) checks for values such as timeouts and thresholds.                                                                                   | `failureThreshold: 3`<br>`initialDelaySeconds: 10`<br>`periodSeconds: 10`<br>`successThreshold: 3`<br>`timeoutSeconds: 5` |
| `resources`              | Allows you to set the [resources](https://kubernetes.io/docs/concepts/configuration/manage-compute-resources-container/) for the `DaemonSet`                                                                                                                                | `requests.cpu: 100m`<br>`requests.memory: 100Mi`<br>`limits.cpu: 1000m`<br>`limits.memory: 200Mi`                         |
| `serviceAccount`         | Custom [serviceAccount](https://kubernetes.io/docs/tasks/configure-pod-container/configure-service-account/) that Metricbeat will use during execution. By default will use the service account created by this chart.                                                      | `""`                                                                                                                      |
| `secretMounts`           | Allows you easily mount a secret as a file inside the `DaemonSet`. Useful for mounting certificates and other secrets. See [values.yaml](./values.yaml) for an example                                                                                                      | `[]`                                                                                                                      |
| `terminationGracePeriod` | Termination period (in seconds) to wait before killing Metricbeat pod process on pod shutdown                                                                                                                                                                               | `30`                                                                                                                      |
| `tolerations`            | Configurable [tolerations](https://kubernetes.io/docs/concepts/configuration/taint-and-toleration/)                                                                                                                                                                         | `[]`                                                                                                                      |
| `nodeSelector`           | Configurable [nodeSelector](https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#nodeselector)                                                                                                                                                                | `{}`                                                                                                                      |
| `affinity`               | Configurable [affinity](https://kubernetes.io/docs/concepts/configuration/assign-pod-node/#affinity-and-anti-affinity)                                                                                                                                                      | `{}`                                                                                                                      |
| `updateStrategy`         | The [updateStrategy](https://kubernetes.io/docs/tasks/manage-daemon/update-daemon-set/#daemonset-update-strategy) for the `DaemonSet`. By default Kubernetes will kill and recreate pods on updates. Setting this to `OnDelete` will require that pods be deleted manually. | `RollingUpdate`                                                                                                           |
| `replicas`               | The replica count for the metricbeat deployment talking to kube-state-metrics                                                                                                                                                                                               | `1`                                                                                                                       |
